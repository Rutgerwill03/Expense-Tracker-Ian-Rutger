<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0a">
<title>Expense Tracker</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #141414;
    --surface-2: #1e1e1e;
    --border: #2a2a2a;
    --text: #e8e8e8;
    --text-dim: #777;
    --accent: #22c55e;
    --accent-dim: rgba(34, 197, 94, 0.12);
    --red: #ef4444;
    --red-dim: rgba(239, 68, 68, 0.12);
    --radius: 14px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'DM Sans', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    overflow-x: hidden;
  }

  .app {
    max-width: 480px;
    margin: 0 auto;
    padding: 0 20px 100px;
  }

  /* Header */
  .header {
    padding: 60px 0 32px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
  }

  .header h1 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent);
  }

  .header .date {
    font-size: 12px;
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
  }

  /* Quick Input */
  .input-section {
    margin-bottom: 24px;
  }

  .input-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-dim);
    margin-bottom: 10px;
    font-family: 'JetBrains Mono', monospace;
  }

  .input-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    display: flex;
    gap: 12px;
    align-items: center;
    transition: border-color 0.2s;
  }

  .input-box:focus-within {
    border-color: var(--accent);
  }

  .input-box input {
    flex: 1;
    background: none;
    border: none;
    color: var(--text);
    font-size: 16px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
  }

  .input-box input::placeholder {
    color: #444;
  }

  .send-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: var(--accent);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.15s, opacity 0.15s;
    flex-shrink: 0;
  }

  .send-btn:active { transform: scale(0.92); }
  .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .send-btn svg { width: 18px; height: 18px; }

  /* Receipt Upload */
  .receipt-section {
    margin-bottom: 32px;
  }

  .receipt-drop {
    background: var(--surface);
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 28px;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
    overflow: hidden;
  }

  .receipt-drop:active { transform: scale(0.98); }

  .receipt-drop.has-image {
    border-color: var(--accent);
    border-style: solid;
    padding: 0;
  }

  .receipt-drop.dragging {
    border-color: var(--accent);
    background: var(--accent-dim);
  }

  .receipt-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: var(--surface-2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 14px;
  }

  .receipt-icon svg { width: 22px; height: 22px; color: var(--text-dim); }

  .receipt-text { font-size: 14px; color: var(--text-dim); }
  .receipt-text strong { color: var(--text); font-weight: 500; }

  .receipt-preview {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 12px;
    display: none;
  }

  .receipt-drop.has-image .receipt-preview { display: block; }
  .receipt-drop.has-image .receipt-placeholder { display: none; }

  .clear-image {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(0,0,0,0.7);
    border: none;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
    backdrop-filter: blur(8px);
  }

  .receipt-drop.has-image .clear-image { display: flex; }

  #fileInput { display: none; }

  /* Submit Receipt */
  .submit-receipt-btn {
    width: 100%;
    padding: 16px;
    border-radius: var(--radius);
    background: var(--accent);
    color: #000;
    font-weight: 600;
    font-size: 15px;
    border: none;
    cursor: pointer;
    margin-top: 12px;
    display: none;
    transition: transform 0.15s, opacity 0.15s;
    font-family: 'DM Sans', sans-serif;
  }

  .submit-receipt-btn.visible { display: block; }
  .submit-receipt-btn:active { transform: scale(0.98); }
  .submit-receipt-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  /* Divider */
  .divider {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
  }

  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .divider span {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-family: 'JetBrains Mono', monospace;
  }

  /* Recent Entries */
  .recent-header {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 14px;
  }

  .entry {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .entry-left { display: flex; flex-direction: column; gap: 4px; }

  .entry-vendor {
    font-weight: 600;
    font-size: 15px;
  }

  .entry-meta {
    font-size: 12px;
    color: var(--text-dim);
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .entry-category {
    background: var(--surface-2);
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-family: 'JetBrains Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .entry-amount {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    font-size: 16px;
    color: var(--accent);
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-dim);
    font-size: 14px;
  }

  /* Status Toast */
  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    padding: 14px 24px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
    z-index: 100;
    transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    max-width: 340px;
    text-align: center;
    backdrop-filter: blur(12px);
  }

  .toast.visible { transform: translateX(-50%) translateY(0); }
  .toast.success { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(34,197,94,0.25); }
  .toast.error { background: var(--red-dim); color: var(--red); border: 1px solid rgba(239,68,68,0.25); }
  .toast.loading { background: var(--surface-2); color: var(--text-dim); border: 1px solid var(--border); }

  /* Config Modal */
  .config-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dim);
    z-index: 50;
    transition: border-color 0.2s;
  }

  .config-toggle:hover { border-color: var(--text-dim); }

  .config-panel {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    z-index: 200;
    display: none;
    align-items: flex-end;
    justify-content: center;
  }

  .config-panel.open { display: flex; }

  .config-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px 20px 0 0;
    padding: 28px 24px 40px;
    width: 100%;
    max-width: 480px;
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }

  .config-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 20px;
    color: var(--accent);
  }

  .config-field { margin-bottom: 16px; }

  .config-field label {
    display: block;
    font-size: 12px;
    color: var(--text-dim);
    margin-bottom: 6px;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0.5px;
  }

  .config-field input {
    width: 100%;
    padding: 12px 14px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-size: 14px;
    font-family: 'JetBrains Mono', monospace;
    outline: none;
    transition: border-color 0.2s;
  }

  .config-field input:focus { border-color: var(--accent); }

  .config-save {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    background: var(--accent);
    color: #000;
    font-weight: 600;
    font-size: 14px;
    border: none;
    cursor: pointer;
    margin-top: 8px;
    font-family: 'DM Sans', sans-serif;
  }

  .config-hint {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 12px;
    line-height: 1.5;
    text-align: center;
  }
</style>
</head>
<body>

<!-- Config Toggle -->
<button class="config-toggle" onclick="toggleConfig()" aria-label="Settings">
  <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
</button>

<!-- Config Panel -->
<div class="config-panel" id="configPanel" onclick="closeConfigOutside(event)">
  <div class="config-content">
    <div class="config-title">⚙ Webhook Config</div>
    <div class="config-field">
      <label>n8n Webhook URL</label>
      <input type="url" id="webhookUrl" placeholder="https://your-n8n.com/webhook/expenses">
    </div>
    <button class="config-save" onclick="saveConfig()">Save</button>
    <p class="config-hint">Paste your n8n webhook URL here. All data is sent directly to your server — nothing stored externally.</p>
  </div>
</div>

<div class="app">
  <!-- Header -->
  <div class="header">
    <h1>Expenses</h1>
    <span class="date" id="currentDate"></span>
  </div>

  <!-- Quick Text Input -->
  <div class="input-section">
    <div class="input-label">Quick Entry</div>
    <div class="input-box">
      <input type="text" id="expenseInput" placeholder='e.g. "15000 groceries Carrefour"' autocomplete="off">
      <button class="send-btn" id="sendTextBtn" onclick="sendText()">
        <svg fill="none" stroke="#000" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
    </div>
  </div>

  <div class="divider"><span>or snap a receipt</span></div>

  <!-- Receipt Photo -->
  <div class="receipt-section">
    <div class="receipt-drop" id="receiptDrop" onclick="document.getElementById('fileInput').click()">
      <div class="receipt-placeholder">
        <div class="receipt-icon">
          <svg fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </div>
        <p class="receipt-text"><strong>Tap to take photo</strong> or upload receipt</p>
      </div>
      <img class="receipt-preview" id="receiptPreview" alt="Receipt preview">
      <button class="clear-image" onclick="clearImage(event)">✕</button>
    </div>
    <input type="file" id="fileInput" accept="image/*" capture="environment" onchange="handleImage(event)">
    <button class="submit-receipt-btn" id="submitReceiptBtn" onclick="sendReceipt()">Scan & Log Receipt</button>
  </div>

  <!-- Recent Entries -->
  <div class="recent-header">Recent</div>
  <div id="entries">
    <div class="empty-state">No expenses logged yet today</div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
  // State
  let imageBase64 = null;
  let entries = JSON.parse(localStorage.getItem('expenses') || '[]');

  // Init
  function init() {
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
      weekday: 'short', month: 'short', day: 'numeric'
    });

    document.getElementById('webhookUrl').value = localStorage.getItem('webhookUrl') || '';

    // Check if webhook is configured
    if (!localStorage.getItem('webhookUrl')) {
      setTimeout(() => toggleConfig(), 500);
    }

    renderEntries();

    // Enter key to send
    document.getElementById('expenseInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendText();
    });
  }

  // Config
  function toggleConfig() {
    document.getElementById('configPanel').classList.toggle('open');
  }

  function closeConfigOutside(e) {
    if (e.target === document.getElementById('configPanel')) toggleConfig();
  }

  function saveConfig() {
    const url = document.getElementById('webhookUrl').value.trim();
    if (!url) return showToast('Enter a webhook URL', 'error');
    localStorage.setItem('webhookUrl', url);
    toggleConfig();
    showToast('Webhook saved ✓', 'success');
  }

  function getWebhookUrl() {
    function getWebhookUrl() {     return https://ianrutger.app.n8n.cloud/webhook-test/73e8d5dc-8169-43c7-93c0-61afcb33a3d2; }
    if (!url) {
      showToast('Set your webhook URL first', 'error');
      setTimeout(() => toggleConfig(), 300);
      return null;
    }
    return url;
  }

  // Image handling
  function handleImage(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      imageBase64 = ev.target.result;
      document.getElementById('receiptPreview').src = imageBase64;
      document.getElementById('receiptDrop').classList.add('has-image');
      document.getElementById('submitReceiptBtn').classList.add('visible');
    };
    reader.readAsDataURL(file);
  }

  function clearImage(e) {
    e.stopPropagation();
    imageBase64 = null;
    document.getElementById('receiptDrop').classList.remove('has-image');
    document.getElementById('submitReceiptBtn').classList.remove('visible');
    document.getElementById('fileInput').value = '';
  }

  // Send text expense
  async function sendText() {
    const input = document.getElementById('expenseInput');
    const message = input.value.trim();
    if (!message) return;

    const url = getWebhookUrl();
    if (!url) return;

    const btn = document.getElementById('sendTextBtn');
    btn.disabled = true;
    showToast('Parsing...', 'loading');

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'text', message })
      });

      const data = await res.json();
      addEntry(data);
      input.value = '';
      showToast('Logged ✓', 'success');
    } catch (err) {
      showToast('Failed to send — check webhook', 'error');
      console.error(err);
    } finally {
      btn.disabled = false;
    }
  }

  // Send receipt image
  async function sendReceipt() {
    if (!imageBase64) return;

    const url = getWebhookUrl();
    if (!url) return;

    const btn = document.getElementById('submitReceiptBtn');
    btn.disabled = true;
    btn.textContent = 'Scanning...';
    showToast('AI is reading your receipt...', 'loading');

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'image', image: imageBase64 })
      });

      const data = await res.json();
      addEntry(data);
      clearImage(new Event('click'));
      showToast('Receipt logged ✓', 'success');
    } catch (err) {
      showToast('Failed — check webhook', 'error');
      console.error(err);
    } finally {
      btn.disabled = false;
      btn.textContent = 'Scan & Log Receipt';
    }
  }

  // Entry management
  function addEntry(data) {
    // Handle various response shapes from n8n
    const entry = {
      vendor: data.vendor || data.Vendor || 'Unknown',
      amount: data.amount || data.Amount || '0',
      currency: data.currency || data.Currency || 'ARS',
      category: data.category || data.Category || 'other',
      date: data.date || data.Date || new Date().toISOString().split('T')[0],
      payment_method: data.payment_method || data.Payment_Method || 'unknown',
      timestamp: Date.now()
    };

    entries.unshift(entry);
    // Keep last 50 entries in local storage
    if (entries.length > 50) entries = entries.slice(0, 50);
    localStorage.setItem('expenses', JSON.stringify(entries));
    renderEntries();
  }

  function renderEntries() {
    const container = document.getElementById('entries');
    if (entries.length === 0) {
      container.innerHTML = '<div class="empty-state">No expenses logged yet today</div>';
      return;
    }

    container.innerHTML = entries.slice(0, 15).map(e => `
      <div class="entry">
        <div class="entry-left">
          <span class="entry-vendor">${escapeHtml(e.vendor)}</span>
          <div class="entry-meta">
            <span class="entry-category">${escapeHtml(e.category)}</span>
            <span>${e.date}</span>
            <span>${e.payment_method}</span>
          </div>
        </div>
        <span class="entry-amount">${formatAmount(e.amount)} ${e.currency}</span>
      </div>
    `).join('');
  }

  function formatAmount(amt) {
    const num = parseFloat(amt);
    if (isNaN(num)) return amt;
    return num.toLocaleString('es-AR');
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // Toast
  function showToast(msg, type) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = `toast ${type} visible`;
    if (type !== 'loading') {
      setTimeout(() => toast.classList.remove('visible'), 2500);
    }
  }

  // Drag and drop support
  const drop = document.getElementById('receiptDrop');
  drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.classList.add('dragging'); });
  drop.addEventListener('dragleave', () => drop.classList.remove('dragging'));
  drop.addEventListener('drop', (e) => {
    e.preventDefault();
    drop.classList.remove('dragging');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        imageBase64 = ev.target.result;
        document.getElementById('receiptPreview').src = imageBase64;
        drop.classList.add('has-image');
        document.getElementById('submitReceiptBtn').classList.add('visible');
      };
      reader.readAsDataURL(file);
    }
  });

  init();
</script>
</body>
</html>
